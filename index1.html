<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
<title>üå± G.R.O.W.T.H. Smart Planter Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body {
    font-family: "Poppins", sans-serif;
    background: url("4.png") no-repeat center center fixed;
    background-size: cover;
    margin: 0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    min-height: 100vh;
    transition: all 0.3s ease;
  }
  h1 { color:#fff;text-align:center;font-size:1.8em;text-shadow:0 2px 4px rgba(0,0,0,0.4); }

  .card {
    backdrop-filter: blur(14px) brightness(1.1);
    background: rgba(255,255,255,0.25);
    border-radius: 20px;
    padding: 18px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.25);
    color: #fff;
    width: 100%;
    transition: transform 0.3s ease;
  }
  .card:hover { transform: translateY(-5px); }

  .flex-row { display:flex;flex-wrap:wrap;gap:20px;justify-content:center;width:100%;max-width:1000px; }
  canvas {width:100%;height:220px;border-radius:10px;border:1px solid rgba(255,255,255,0.4);background:rgba(255,255,255,0.05);}
  #errorList {white-space:pre-line;font-size:0.9em;}
  .switch-row {display:flex;gap:30px;justify-content:center;flex-wrap:wrap;width:100%;max-width:600px;}
  .switch-block {display:flex;align-items:center;gap:10px;backdrop-filter:blur(8px);background:rgba(255,255,255,0.2);border-radius:16px;padding:10px 18px;box-shadow:0 2px 10px rgba(0,0,0,0.2);}
  .switch-label {color:#fff;font-weight:bold;min-width:120px;}
  .switch {position:relative;width:56px;height:30px;}
  .switch input {display:none;}
  .slider {position:absolute;top:0;left:0;right:0;bottom:0;background-color:rgba(255,255,255,0.3);border-radius:34px;transition:0.3s;}
  .slider:before {content:"";position:absolute;height:22px;width:22px;left:4px;bottom:4px;background:white;border-radius:50%;transition:0.3s;}
  input.pump:checked + .slider {background-color:#2196f3;}
  input.mist:checked + .slider {background-color:#f4d03f;}
  input:checked + .slider:before {transform:translateX(26px);}
  .grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:14px;width:100%;max-width:800px;}
  .icon {font-size:2em;margin-bottom:8px;}
  .reading-val {font-weight:bold;transition:color 0.3s ease;}
  #infoBar {color:#fff;font-size:0.95em;text-shadow:0 1px 3px rgba(0,0,0,0.3);margin-bottom:5px;}
  button {background:rgba(255,255,255,0.3);color:#fff;border:none;border-radius:10px;padding:8px 14px;cursor:pointer;transition:background 0.3s;}
  button:hover {background:rgba(255,255,255,0.5);}
</style>
</head>

<body>
  <h1>üå± G.R.O.W.T.H. Smart Planter Dashboard</h1>
  <div id="infoBar">Loading weather and time...</div>

  <div class="flex-row">
    <div class="card" style="flex:1;min-width:300px;">
      <h3>Plant Health (Last 3 Days)</h3>
      <canvas id="barChart"></canvas>
    </div>
    <div class="card" style="flex:1;min-width:300px;">
      <h3>NPK Ratio</h3>
      <canvas id="pieChart"></canvas>
      <div id="npkError">Error from ideal: --%</div>
    </div>
  </div>

  <div class="card" style="max-width:800px;">
    <h3>Individual Variable Errors</h3>
    <div id="errorList"></div>
    <button id="exportBtn">üìä Export Daily Log</button>
  </div>

  <div class="switch-row">
    <div class="switch-block">
      <span class="switch-label">Switch Pump</span>
      <label class="switch"><input id="pumpToggle" class="pump" type="checkbox"/><span class="slider"></span></label>
    </div>
    <div class="switch-block">
      <span class="switch-label">Switch Fertilizer</span>
      <label class="switch"><input id="mistToggle" class="mist" type="checkbox"/><span class="slider"></span></label>
    </div>
  </div>

  <div class="grid" id="readingsGrid">
    <div class="card"><div class="icon">üå°Ô∏è</div><div id="tempval" class="reading-val">-- ¬∞C</div><div>Temperature</div></div>
    <div class="card"><div class="icon">üíß</div><div id="humidityval" class="reading-val">-- %</div><div>Humidity</div></div>
    <div class="card"><div class="icon">‚ö°</div><div id="conductivityval" class="reading-val">--</div><div>Conductivity</div></div>
    <div class="card"><div class="icon">‚òÄÔ∏è</div><div id="luxval" class="reading-val">--</div><div>Light</div></div>
    <div class="card"><div class="icon">üí¶</div><div id="moistureval" class="reading-val">-- %</div><div>Soil Moisture</div></div>
    <div class="card"><div class="icon">üåà</div><div id="phval" class="reading-val">--</div><div>pH Level</div></div>
  </div>

<script type="module">
// ‚úÖ Firebase v10 (Stable CDN Import)
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getDatabase, ref, onValue, set, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD21J-omPyBAXvjDFPANzpFg4a3AWchbFQ",
  authDomain: "tanim-ashs.firebaseapp.com",
  databaseURL: "https://tanim-ashs-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "tanim-ashs",
  storageBucket: "tanim-ashs.firebasestorage.app",
  messagingSenderId: "459105073919",
  appId: "1:459105073919:web:ab6cb0346d87233d79aaca",
  measurementId: "G-Q16E4V78WQ"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

console.log("üî• Firebase Initialized");

// === References ===
const readingsRef = query(ref(db, "/TANIM-ASHS/readings"), limitToLast(15));
const idealsRef = ref(db, "/TANIM-ASHS/ideals");
const pumpRef = ref(db, "/TANIM-ASHS/bools/pump");
const mistRef = ref(db, "/TANIM-ASHS/bools/mist");

// === Charts ===
const barChart = new Chart(document.getElementById("barChart"), {
  type: "bar",
  data: { labels: ["2 Days Ago", "Yesterday", "Today"], datasets: [{ label: "Health (%)", data: [0, 0, 0], backgroundColor: "#a3f7bf" }] },
  options: { scales: { y: { beginAtZero: true, max: 100 } } }
});
const pieChart = new Chart(document.getElementById("pieChart"), {
  type: "pie",
  data: { labels: ["N", "P", "K"], datasets: [{ data: [0, 0, 0], backgroundColor: ["#0077b6", "#00b4d8", "#90e0ef"] }] }
});

let ideals = {}, lastDailyLogs = [];

onValue(idealsRef, snap => {
  ideals = snap.val() || {};
  console.log("üåø Ideals loaded:", ideals);
});

onValue(readingsRef, snapshot => {
  const data = snapshot.val();
  if (!data) return;

  console.log("üì• Readings:", data);
  const now = new Date();
  const today = [], yesterday = [], twoDaysAgo = [];
  let latest = null;

  Object.keys(data).forEach(id => {
    const e = data[id];
    if (!e) return;
    const ts = new Date(e.timestamp || Date.now());
    const diffDays = Math.floor((now - ts) / (1000 * 60 * 60 * 24));
    if (diffDays === 0) today.push(e);
    else if (diffDays === 1) yesterday.push(e);
    else if (diffDays === 2) twoDaysAgo.push(e);
    latest = e;
  });

  if (!latest || !ideals.N) return;

  const weights = { Temp: 0.2, Humidity: 0.15, Conductivity: 0.15, Lux: 0.15, PH: 0.15, Moisture: 0.2 };
  function computeHealth(entry) {
    let h = 0;
    for (let k in weights) {
      const val = parseFloat(entry[k]) || 0;
      const ideal = parseFloat(ideals[k]) || 1;
      const err = Math.abs((val - ideal) / ideal) * 100;
      h += Math.max(0, 100 - err) * weights[k];
    }
    return h;
  }

  const avgH = arr => arr.length ? arr.map(computeHealth).reduce((a,b)=>a+b,0)/arr.length : 0;
  barChart.data.datasets[0].data = [avgH(twoDaysAgo), avgH(yesterday), avgH(today)];
  barChart.update();

  const { Temp, Humidity, Conductivity, Lux, Moisture, PH, N, P, K } = latest;
  const readings = { Temp, Humidity, Conductivity, Lux, Moisture, PH };
  for (let k in readings) {
    const el = document.getElementById(k.toLowerCase() + "val");
    if (!el) continue;
    el.textContent = readings[k] + (k === "Temp" ? " ¬∞C" : k === "PH" ? "" : " %");
  }

  // ‚úÖ NPK Error vs Ideal
  const errN = Math.abs((N - ideals.N) / ideals.N) * 100;
  const errP = Math.abs((P - ideals.P) / ideals.P) * 100;
  const errK = Math.abs((K - ideals.K) / ideals.K) * 100;
  document.getElementById("npkError").textContent = `Error from ideal: N=${errN.toFixed(1)}%, P=${errP.toFixed(1)}%, K=${errK.toFixed(1)}%`;

  pieChart.data.datasets[0].data = [N, P, K];
  pieChart.update();

  let errTxt = "";
  for (let k in weights) {
    const val = parseFloat(readings[k]) || 0;
    const ideal = parseFloat(ideals[k]) || 1;
    errTxt += `‚Ä¢ ${k}: ${((Math.abs(val - ideal) / ideal) * 100).toFixed(1)}% off\n`;
  }
  document.getElementById("errorList").textContent = errTxt;
});

onValue(pumpRef, s => document.getElementById("pumpToggle").checked = s.val());
onValue(mistRef, s => document.getElementById("mistToggle").checked = s.val());
document.getElementById("pumpToggle").onchange = e => set(pumpRef, e.target.checked);
document.getElementById("mistToggle").onchange = e => set(mistRef, e.target.checked);

document.getElementById("exportBtn").onclick = () => {
  const rows = [["Timestamp","Temp","Humidity","Conductivity","Lux","Moisture","PH","N","P","K"]];
  lastDailyLogs.forEach(r => rows.push(Object.values(r)));
  const csv = rows.map(r => r.join(",")).join("\n");
  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "plant_log.csv";
  a.click();
};

async function updateInfoBar() {
  const now = new Date().toLocaleString();
  try {
    const res = await fetch("https://api.open-meteo.com/v1/forecast?latitude=14.6&longitude=121.0&current=temperature_2m");
    const json = await res.json();
    document.getElementById("infoBar").textContent = `${now} | Weather: ${json.current.temperature_2m}¬∞C`;
  } catch {
    document.getElementById("infoBar").textContent = now;
  }
}
setInterval(updateInfoBar, 60000);
updateInfoBar();
</script>
</body>
</html>
